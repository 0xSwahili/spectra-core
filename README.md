# Spectra Protocol contest details

- [Spectra Protocol contest details](#spectra-protocol-contest-details)
- [Overview](#overview)
  - [Architecture Overview](#architecture-overview)
    - [High Level Contracts Architecture](#high-level-contracts-architecture)
      - [Principal Token](#principal-token)
      - [Yield Token](#yield-token)
      - [Router](#router)
      - [Utils](#utils)
      - [Factory](#factory)
      - [Registry](#registry)
    - [Access Manager and Ownable](#access-manager-and-ownable)
  - [Documentation](#documentation)
  - [Scope](#scope)
- [Acknowledged Findings](#acknowledged-findings)
  - [Code Unreachable](#code-unreachable)
  - [Reverting Transactions When PT rate is Zero](#reverting-transactions-when-ptrate-is-zero)
  - [Curve introduce imprecisions](#curve-introduce-imprecisions)
  - [The Principal Token contract expect a compliant ERC4626 and non malicious IBT](#the-principal-token-contract-expect-a-compliant-erc4626-and-non-malicious-ibt)
  - [Access Control Trust Model](#access-control-trust-model)
- [Recommendations (where to look for)](#recommendations-where-to-look-for)
- [Invariants](#invariants)
  - [PrincipalToken invariants](#principaltoken-invariants)
- [Installation - Setup](#installation---setup)
  - [Installation](#installation)
  - [Submodules](#submodules)
  - [Compilation](#compilation)
  - [Testing](#testing)


# Overview

Spectra is a permissionless interest rate derivatives protocol for DeFi. The protocol allows to split the yield generated by an Interest Bearing Token (IBT) from the principal asset. The IBT is deposited in the protocol and the user receives Principal Tokens (PT) and Yield Tokens (YT) in return. The PT represents the principal asset and the YT represents the yield generated by the IBT. Holders of the yield token for a specific IBT can claim the yield generated by the corresponding deposited IBTs during the time they hold the YT. 

## Architecture Overview

### High Level Contracts Architecture
![Spectra Contracts Architecture](./spectra_contracts_architecture.png)

#### Principal Token

> *[PrincipalToken](./src/tokens/PrincipalToken.sol)*

This is the core contract of Spectra. The Principal Token is [EIP-5095](https://eips.ethereum.org/EIPS/eip-5095) and [EIP-2612](https://eips.ethereum.org/EIPS/eip-2612) compliant. Users can deposit an [EIP-4626](https://eips.ethereum.org/EIPS/eip-4626) IBT or the underlying token of that IBT and receive Principal Tokens (PT) and Yield Tokens (YT). The PT contract holds the logic that separates the yield generated from the principal asset deposited in the IBT.

#### Yield Token

> *[YieldToken](./src/tokens/YieldToken.sol)*

This contract represents the Yield Token (YT). The YT is an [EIP-20](https://eips.ethereum.org/EIPS/eip-20) token and follows the [EIP-2612](https://eips.ethereum.org/EIPS/eip-2612) standard. The same amount of PT and YT is minted upon depositing into the protocol (`PrincipalToken.deposit`, `PrincipalToken.depositIBT`). The YT captures the yield generated by the deposited principal. Holding the YT allows the user to claim the corresponding amount of yield generated by the IBTs deposited in the associated PT contract.

#### Router

> *[Router](./src/router/Router.sol)*

This is a utility contract designed to perform operations like swapping in a Curve pool, adding/removing liquidity and wrapping/unwrapping of PTs and ERC4626 IBTs. It also includes utility functions for simulating a sequence of operations with a specified input amount, as well as an absolute simulation that does not account for fees and slippage.

#### Utils

> *[PrincipalTokenUtil](src/libraries/PrincipalTokenUtil.sol), [CurvePoolUtil](src/libraries/CurvePoolUtil.sol), [Roles](src/libraries/Roles.sol), [NamingUtil](src/libraries/NamingUtil.sol)*

Different libraries are used to perform calculation and recurrent PT operations, or the naming of the tokens created by the protocol. The `Roles` library hold the list of Roles IDs used by the [Access Manager](#access-manager-and-ownable). The `CurvePoolUtil` library holds some logic for computations and interactions with Curve pools.

#### Factory

> *[Factory](./src/factory/Factory.sol)*

This is the contract which is used to deploy PTs and Curve pools. Upon deployment, the factory will register the new contracts in the registry.

#### Registry

> *[Registry](./src/Registry.sol)*

This contract stores protocol addresses such as the Factory, Router and PTs. It also maintains fee values.

#### Access Manager and Ownable

The Spectra protocol implements the [OpenZeppelin AccessManager](https://docs.openzeppelin.com/contracts/5.x/api/access#accessmanager).

The following roles are defined:
- `ADMIN_ROLE` - roleId `0` - the Access Manager super admin. Can grant and revoke any role. Set by default in the Access Manager constructor.
- `UPGRADER_ROLE` - roleId `1` - the users who can upgrade the protocol implementations.
- `PAUSER_ROLE` - roleId `2` - the DAO address that can pause the protocol (in case of emergency).
- `FEE_SETTER_ROLE` - roleId `3` - the role that can change the fees in the protocol.
- `REGISTRY_ROLE` - roleId `4` - the users who can call the registry contract to register new contracts addresses.
- `REWARDS_HARVESTER_ROLE` - roleId `5` - the DAO address that can harvest the additional rewards generated by the IBT holdings of the protocol (redistributed to users).
- `REWARDS_PROXY_SETTER_ROLE` - roleId `6` - the DAO address that can setup a rewards proxy to be able to claim IBT rewards.

## Documentation

- You can refer to the [protocol documentation](https://docs.spectra.finance/) for a general understanding of the protocol.
- To have a better understanding of how the contracts interact and behaves please refer to the [developers doc](https://dev.spectra.finance)

## Scope

| Contract                                        | SLOC | Purpose                                                                                                                                                                                                                                | Libraries used                         |
| ----------------------------------------------- | ---- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------- |
| [src/Registry.sol](./src/Registry.sol)                            | 165  | Hold the different Spectra protocol addresses  and fees                                                                                                                                                                                | openzeppelin, openzeppelin-upgradeable |
| [src/factory/Factory.sol](./src/factory/Factory.sol)                     | 284  | The Factory is used to deploy any PrincipalToken and Curve pools permissionlessly.                                                                                                                                           | openzeppelin, openzeppelin-upgradeable |
| [src/proxy/AMBeacon.sol](./src/proxy/AMBeacon.sol)                      | 24   | Modified from Openzeppelin Beacon using Openzeppelin [Access Manager](https://docs.openzeppelin.com/contracts/5.x/api/access#AccessManager) instead of Ownable                                                                         | openzeppelin                           |
| [src/proxy/AMProxyAdmin.sol](./src/proxy/AMProxyAdmin.sol)                  | 14   | Modified from [Openzeppelin ProxyAdmin](https://docs.openzeppelin.com/contracts/5.x/api/proxy#ProxyAdmin) using Openzeppelin [Access Manager](https://docs.openzeppelin.com/contracts/5.x/api/access#AccessManager) instead of Ownable | openzeppelin                           |
| [src/proxy/AMTransparentUpgradeableProxy.sol]() | 42   | Modified from [Openzeppelin TransparentUpgradeableProxy](https://docs.openzeppelin.com/contracts/5.x/api/proxy#TransparentUpgradeableProxy) using AMProxyAdmin instead of   Ownable                                                    | openzeppelin                           |
| [src/router/Commands.sol](./src/router/Commands.sol)                     | 20   | The Router supported commands                                                                                                                                                                                                          |                                        |
| [src/router/util/RouterUtil.sol](./src/router/util/RouterUtil.sol)              | 187  | Util contract that handle computations for the router                                                                                                                                                                                  | openzeppelin, openzeppelin-upgradeable |
| [src/router/Constants.sol]()                    | 10    | The constants used by the Router                                                                                                                                                                                                       |                                        |
| [src/router/Dispatcher.sol](./src/router/Dispatcher.sol)                   | 332  | The dispatcher interpret and execute the different Router commands                                                                                                                                                                     | openzeppelin                           |
| [src/router/Router.sol](./src/router/Router.sol)                       | 117  | The Router contract that allows in a single call to execute multiple protocol operations                                                                                                                                               | openzeppelin, openzeppelin-upgradeable |
| [src/tokens/PrincipalToken.sol](./src/tokens/PrincipalToken.sol)               | 649  | The Principal Token is the main contract of Spectra. Users deposit their IBT in exchange for Principal Token and Yield Token                                                                                                           | openzeppelin, openzeppelin-upgradeable |
| [src/tokens/YieldToken.sol](./src/tokens/YieldToken.sol)                   | 73   | Holders of the yield token for a specific IBT can claim the yield generated by the corresponding deposited IBTs                                                                                                                        | openzeppelin                           |
| [src/libraries/PrincipalTokenUtil.sol](./src/libraries/PrincipalTokenUtil.sol)        | 142  | Utility library for the Principal Token contract                                                                                                                                                                                       | openzeppelin, openzeppelin-upgradeable |
| [src/libraries/RayMath.sol](./src/libraries/RayMath.sol)                   | 32   | Library for number conversions from decimals between 6 and 18 to 27 decimals  (ray)                                                                                                                                                 |                                        |
| [src/libraries/CurvePoolUtil.sol](./src/libraries/CurvePoolUtil.sol)                     | 150    | Util library with helper methods to manage curve liquidity                                                                                                         |                                        | 

# Acknowledged Findings

## Code Unreachable

Custom errors are implemented for scenarios that theoretically should not occur and could be harmful for the end user. These errors cater to instances where code is considered unreachable. However, in cases of invariant violation, the code might be accessible. An example of this is found in the `_computeYield` method of the `PrincipalTokenUtil` library.

## Reverting Transactions When PT rate is Zero

The PT rate accounts for a negative rate on the IBT (Interest Bearing Token). A decrease in the PT rate occurs when the IBT experiences a negative rate. The PT rate does not increase; it can only be zero if the IBT rate is also zero, indicating no claimable underlying assets in the IBT (e.g., if the IBT is drained due to a hack), rendering the IBT worthless and prohibiting interaction with the protocol.

## Curve introduces imprecisions

The Curve AMM introduces some imprecisions (noise fee) that is taken into account in the Router but can lead to imprecisions in the `previewRate` of the Router. 

## The Principal Token contract expects a compliant ERC4626 and non malicious IBT 

The protocol relies on trusting the integrated IBT. A malicious actor could create a malicious compliant ([EIP4626](https://eips.ethereum.org/EIPS/eip-4626)) IBT that could break the protocol and might result in a loss of funds for the users.

## Access Control Trust Model

Certain functions are secured with an OpenZeppelin Access Manager contract, enabling centralized role management distributed to DAO accounts.

Some IBTs are elligible for additional rewards, and the DAO can claim these rewards and redistribute them to the users. The DAO will be able for such IBTs to setup a reward proxy on top of the PT contract to be able to claim the rewards. The DAO is the only entity that can perform these operations.

# Recommendations (where to look for)

- Decimals imprecisions should always benefit the protocol and no user should be able to extract extra value.
- YT flash swaps allow for leveraged operations check the potential price impact in the Curve Pool.
- Proxy Admin and Beacon are a modified version of Openzepelin origin contract replacin OZ Ownable with OZ Access Managed. Check if this modification can be harmful outside of our trust model ([see above](https://www.notion.so/V2-C4-dfec6a803eac4214b2a63e406250a172?pvs=21)).
- Imprecisions and rounding errors.
- Manipulation of the IBT rate.
- Mechanism of negative rates and the impact on the PT rate. [See docs](https://dev.spectra.finance/technical-reference/yield-calculations)

# Invariants

## PrincipalToken invariants

**IBT rate is only updated upon user interactions with our protocol**

**PT rate is only updated after an accounted negative rate change on the IBT rate**

**PT and its YT should have an equal supply at all times**

**PT rate should not increase**

`ptRateOfUser(u) ≥ ptRate` for all `u` in `users` with `users` being all the users that deposited in the PT.

**Accounted IBT rate cannot decrease without impacting PT rate**

If the protocol records an IBT rate decrease, the PT rate has to decrease to account for the negative rate.

**Principal Token is ERC5095**

All [EIP-5095](https://eips.ethereum.org/EIPS/eip-5095) invariants should hold such as `previewRedeem ≥ redeem`.

**Principal Token deposit**

`previewDeposit ≤ deposit` : the preview of shares minted upon depositing should be less than or equal to the actual shares minted.

# Installation - Setup 

## Installation

Follow [this link](https://book.getfoundry.sh/getting-started/installation) to install Foundry, Forge, Cast and Anvil.

Do not forget to update Foundry regularly with the following command

```properties
foundryup
```

Similarly for forge-std run

```properties
forge update lib/forge-std
```

## Submodules

Run below command to include/update all git submodules like openzeppelin contracts, forge-std etc (`lib/`)

```properties
git submodule update --init --recursive
```

To get the `node_modules/` directory run

```properties
yarn
```

## Compilation

To compile your contracts run

```properties
forge build
```

## Testing

Run your tests with

```properties
forge test
```

Find more information on testing with Foundry [here](https://book.getfoundry.sh/forge/tests)

Note: tests might take a long time due to the number of fuzz runs. You can modify the `runs` parameter under the `[fuzz]` section of the `foundry.toml` file as per your needs.
